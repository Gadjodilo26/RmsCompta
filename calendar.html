<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agenda ‚Äî Compta locale</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="page-transition.js" defer></script>
  </head>
  <body>
    <div class="app">
      <header class="site-header">
        <img src="logoOfficielRMS.svg" alt="Logo" class="site-logo" />
        <h1>Agenda & √©v√©nements</h1>
        <p>Renseignez vos √©v√©nements clients et visualisez-les dans un calendrier accessible.</p>
      </header>

      <section class="meta-card">
        <h2>Actions rapides</h2>
        <div class="file-actions">
          <a class="btn btn-primary" href="index.html">Retour tableau de bord</a>
          <a class="btn btn-secondary" href="contacts.html" aria-label="Fiches clients">üë§</a>
          <button class="btn btn-secondary" id="export-events">Exporter</button>
          <label class="btn btn-secondary" for="import-events">Importer</label>
          <input type="file" id="import-events" accept="application/json" hidden />
        </div>
      </section>

      <section class="panel active">
        <h2 class="day-title">Nouvel √©v√©nement</h2>
        <form id="event-form" class="entry-form">
          <div class="form-grid">
            <div class="form-field">
              <label>Titre</label>
              <input type="text" id="event-title" required />
            </div>
            <div class="form-field">
              <label>Date</label>
              <input type="date" id="event-date" required />
            </div>
            <div class="form-field">
              <label>D√©but</label>
              <input type="time" id="event-start" />
            </div>
            <div class="form-field">
              <label>Fin</label>
              <input type="time" id="event-end" />
            </div>
            <div class="form-field">
              <label>Lieu</label>
              <input type="text" id="event-place" placeholder="Adresse ou r√©union en ligne" />
            </div>
            <div class="form-field">
              <label>Client associ√©</label>
              <select id="event-client">
                <option value="">Sans client</option>
              </select>
            </div>
            <div class="form-field">
              <label>Type</label>
              <input type="text" id="event-type" placeholder="Rendez-vous, livraison, chantier..." />
            </div>
            <div class="form-field">
              <label>Notes</label>
              <textarea id="event-notes" rows="2"></textarea>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Ajouter l'√©v√©nement</button>
            <button type="button" class="btn btn-secondary" id="reset-event">Effacer</button>
          </div>
        </form>
      </section>

      <section class="panel active">
        <h2 class="day-title">Calendrier</h2>
        <div class="panel-content">
          <div class="form-field">
            <label for="event-month">Mois</label>
            <input type="month" id="event-month" />
          </div>
          <div class="calendar-legend">
            <span class="legend income">√âv√©nement</span>
          </div>
          <div class="calendar-grid" id="event-calendar"></div>
          <div class="meta-card" id="day-detail" hidden>
            <h3>√âv√©nements du <span id="detail-date">-</span></h3>
            <div id="detail-list"></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      (() => {
        const STORAGE_KEY = "comptaCalendar";
        const MAIN_STORAGE = "comptaLocaleTemplate";
        let events = [];
        let clients = [];
        let currentMonth = null;

        function loadMainClients() {
          try {
            const raw = localStorage.getItem(MAIN_STORAGE);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            clients = Array.isArray(parsed?.contacts?.clients) ? parsed.contacts.clients : [];
          } catch (e) {
            console.warn("Impossible de charger les clients principaux", e);
          }
        }

        function loadEvents() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            events = raw ? JSON.parse(raw) : [];
          } catch (e) {
            events = [];
          }
        }

        function saveEvents() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
          renderEvents();
        }

        function renderClientsSelect() {
          const select = document.getElementById("event-client");
          if (!select) return;
          const current = select.value;
          select.innerHTML = '<option value=\"\">Sans client</option>';
          clients.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
          });
          select.value = current || "";
        }

        function renderEvents() {
          renderCalendar();
        }

        function resolveClient(id) {
          if (!id) return "";
          const found = clients.find((c) => c.id === id);
          return found ? found.name : "";
        }

        function addEvent(ev) {
          events.push(ev);
          saveEvents();
        }

        function handleSubmit(e) {
          e.preventDefault();
          const title = document.getElementById("event-title").value.trim();
          const date = document.getElementById("event-date").value;
          if (!title || !date) return;
          addEvent({
            title,
            date,
            start: document.getElementById("event-start").value,
            end: document.getElementById("event-end").value,
            place: document.getElementById("event-place").value,
            clientId: document.getElementById("event-client").value,
            type: document.getElementById("event-type").value,
            notes: document.getElementById("event-notes").value,
          });
          e.target.reset();
        }

        function exportEvents() {
          const blob = new Blob([JSON.stringify(events, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "agenda.json";
          a.click();
          URL.revokeObjectURL(url);
        }

        function importEvents(file) {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const imported = JSON.parse(reader.result);
              if (Array.isArray(imported)) {
                events = imported;
                saveEvents();
              } else {
                alert("Fichier invalide");
              }
            } catch (e) {
              alert("Import impossible");
            }
          };
          reader.readAsText(file);
        }

        document.getElementById("event-form").addEventListener("submit", handleSubmit);
        document.getElementById("reset-event").addEventListener("click", () => {
          document.getElementById("event-form").reset();
        });
        document.getElementById("export-events").addEventListener("click", exportEvents);
        document.getElementById("import-events").addEventListener("change", (e) => {
          const f = e.target.files[0];
          if (f) importEvents(f);
          e.target.value = "";
        });
        document.getElementById("event-month").addEventListener("input", renderCalendar);

        loadMainClients();
        loadEvents();
        renderClientsSelect();
        renderEvents();

        function renderCalendar() {
          const container = document.getElementById("event-calendar");
          if (!container) return;
          const monthInput = document.getElementById("event-month");
          if (!monthInput.value) monthInput.value = buildMonthString(new Date());
          const { start, days } = buildCalendar(monthInput.value);
          currentMonth = start;
          const eventsByDay = groupEventsByDay(monthInput.value);
          container.innerHTML = days
            .map(({ date, label, inMonth }) => {
              const iso = toISODate(date);
              const count = eventsByDay[iso]?.length || 0;
              return `
                <button class="calendar-cell ${inMonth ? "" : "inactive"}" data-date="${iso}" aria-label="${label} : ${count} √©v√©nement(s)">
                  <div>${label}</div>
                  ${count ? `<div class="cell-total" style="color:#16a34a;">${count}</div>` : ""}
                </button>
              `;
            })
            .join("");
          container.querySelectorAll("[data-date]").forEach((btn) => {
            btn.addEventListener("click", () => showDayDetail(btn.dataset.date, eventsByDay[btn.dataset.date] || []));
          });
        }

        function buildMonthString(date) {
          const d = new Date(date);
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
        }

        function buildCalendar(monthValue) {
          const [yearStr, monthStr] = monthValue.split("-");
          const year = Number(yearStr) || new Date().getFullYear();
          const month = Number(monthStr) || new Date().getMonth() + 1;
          const start = new Date(year, month - 1, 1);
          const end = new Date(year, month, 0);
          const firstDay = new Date(start);
          const offset = (firstDay.getDay() + 6) % 7;
          const days = [];
          const cursor = new Date(start);
          cursor.setDate(cursor.getDate() - offset);
          for (let i = 0; i < 42; i++) {
            days.push({
              date: new Date(cursor),
              label: String(cursor.getDate()).padStart(2, "0"),
              inMonth: cursor >= start && cursor <= end,
            });
            cursor.setDate(cursor.getDate() + 1);
          }
          return { start, days };
        }

        function toISODate(date) {
          return date.toISOString().slice(0, 10);
        }

        function groupEventsByDay(monthValue) {
          const [yearStr, monthStr] = monthValue.split("-");
          const year = Number(yearStr);
          const month = Number(monthStr);
          return events.reduce((acc, ev) => {
            if (!ev.date) return acc;
            const d = new Date(ev.date);
            if (d.getFullYear() !== year || d.getMonth() + 1 !== month) return acc;
            const iso = ev.date;
            if (!acc[iso]) acc[iso] = [];
            acc[iso].push(ev);
            return acc;
          }, {});
        }

        function showDayDetail(date, dayEvents) {
          const panel = document.getElementById("day-detail");
          const title = document.getElementById("detail-date");
          const list = document.getElementById("detail-list");
          if (title) title.textContent = date || "-";
          if (list) {
            list.innerHTML =
              dayEvents
                .map(
                  (ev, index) => `
                <div class="meta-card">
                  <strong>${ev.title || "Sans titre"}</strong>
                  <div>${ev.start || "-"} ‚Äì ${ev.end || "-"}</div>
                  <div>${ev.place || ""}</div>
                  <div>${resolveClient(ev.clientId) || ""}</div>
                  <div>${ev.type || ""}</div>
                  <div>${ev.notes || ""}</div>
                  <button class="table-link danger" data-action="delete" data-index="${findEventIndex(ev)}">Supprimer</button>
                </div>
              `
                )
                .join("") || "<p>Aucun √©v√©nement</p>";
            list.querySelectorAll("[data-action='delete']").forEach((btn) => {
              btn.addEventListener("click", () => {
                const idx = Number(btn.dataset.index);
                if (!Number.isFinite(idx)) return;
                events.splice(idx, 1);
                saveEvents();
                showDayDetail(date, (groupEventsByDay(buildMonthString(currentMonth))[date] || []));
              });
            });
          }
          if (panel) panel.hidden = false;
          // Notification compacte : seulement le nombre d'√©v√©nements sur la journ√©e
          notify(String(dayEvents.length || 0));
        }

        function findEventIndex(ev) {
          return events.findIndex(
            (item) =>
              item.title === ev.title &&
              item.date === ev.date &&
              item.start === ev.start &&
              item.end === ev.end &&
              item.notes === ev.notes
          );
        }

        function notify(message) {
          if (!message) return;
          const note = document.createElement("div");
          note.style.position = "fixed";
          note.style.bottom = "16px";
          note.style.right = "16px";
          note.style.background = "#0f172a";
          note.style.color = "#fff";
          note.style.padding = "10px 14px";
          note.style.borderRadius = "8px";
          note.style.boxShadow = "0 10px 30px rgba(0,0,0,0.2)";
          note.textContent = message;
          document.body.appendChild(note);
          setTimeout(() => note.remove(), 2000);
        }
      })();
    </script>

    <button class="quick-comm-btn" id="quick-comm-btn" aria-label="Contacts rapides">üìû</button>
    <div class="quick-comm-panel" id="quick-comm-panel">
      <h3 style="margin: 4px 0 10px;">Contact rapide</h3>
      <div class="form-field">
        <label for="qc-contact">Contact</label>
        <select id="qc-contact">
          <option value="">S√©lectionner</option>
        </select>
      </div>
      <div class="quick-comm-row">
        <div class="form-field">
          <label for="qc-phone">T√©l√©phone</label>
          <input type="tel" id="qc-phone" />
        </div>
        <div class="form-field">
          <label for="qc-email">Email</label>
          <input type="email" id="qc-email" />
        </div>
      </div>
      <div class="form-field">
        <label for="qc-message">Message (SMS / email)</label>
        <textarea id="qc-message" rows="2" placeholder="Bonjour, ..."></textarea>
      </div>
      <div class="form-field">
        <label for="qc-subject">Sujet (email)</label>
        <input type="text" id="qc-subject" placeholder="Sujet" />
      </div>
      <div class="form-field">
        <label for="qc-preset">Pr√©rremplissage</label>
        <select id="qc-preset">
          <option value="">Choisir un mod√®le</option>
          <option value="callback">Je vous rappelle</option>
          <option value="first">Premier contact</option>
          <option value="quote">Relance devis</option>
          <option value="thankyou">Merci / cl√¥ture</option>
          <option value="rdv-confirm">Confirmation rendez-vous</option>
          <option value="rdv-reminder">Rappel rendez-vous</option>
        </select>
      </div>
      <div class="quick-comm-actions">
        <a id="qc-call" class="btn btn-primary" href="#" aria-disabled="true" title="Appeler">üìû</a>
        <a id="qc-sms" class="btn btn-secondary" href="#" aria-disabled="true" title="SMS">üí¨</a>
        <a id="qc-mail" class="btn btn-secondary" href="#" aria-disabled="true" title="Email">‚úâÔ∏è</a>
      </div>
    </div>

    <script>
      (() => {
        const MAIN_STORAGE = "comptaLocaleTemplate";
        let contacts = [];

        function loadContacts() {
          try {
            const raw = localStorage.getItem(MAIN_STORAGE);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            contacts = [
              ...(Array.isArray(parsed?.contacts?.clients) ? parsed.contacts.clients : []),
              ...(Array.isArray(parsed?.contacts?.fournisseurs) ? parsed.contacts.fournisseurs : []),
            ];
          } catch (e) {
            contacts = [];
          }
        }

        function renderSelect() {
          const select = document.getElementById("qc-contact");
          if (!select) return;
          const current = select.value;
          select.innerHTML = '<option value=\"\">S√©lectionner</option>';
          contacts.forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.name || "Contact";
            select.appendChild(opt);
          });
          select.value = current || "";
          updateLinks();
        }

        function selected() {
          const select = document.getElementById("qc-contact");
          if (!select) return null;
          return contacts.find((c) => c.id === select.value) || null;
        }

        function updateLinks() {
          const contact = selected();
          const phoneInput = document.getElementById("qc-phone");
          const emailInput = document.getElementById("qc-email");
          const msgInput = document.getElementById("qc-message");
          const subjectInput = document.getElementById("qc-subject");
          const presetSelect = document.getElementById("qc-preset");
          const callLink = document.getElementById("qc-call");
          const smsLink = document.getElementById("qc-sms");
          const mailLink = document.getElementById("qc-mail");
          const phone = (contact?.phone || phoneInput?.value || "").trim();
          const email = (contact?.email || emailInput?.value || "").trim();
          if (phoneInput) phoneInput.value = phone;
          if (emailInput) emailInput.value = email;
          if (presetSelect && presetSelect.value) {
            const msg = getPresetText(presetSelect.value, contact);
            if (msgInput) msgInput.value = msg;
            if (presetSelect.value.includes("rdv") && subjectInput && !subjectInput.value) {
              subjectInput.value = "Rendez-vous";
            }
          }
          const message = msgInput?.value || "";
          const subject = subjectInput?.value || "";
          if (callLink) {
            callLink.href = phone ? `tel:${phone}` : "#";
            callLink.setAttribute("aria-disabled", phone ? "false" : "true");
          }
          if (smsLink) {
            const body = encodeURIComponent(message);
            smsLink.href = phone ? `sms:${phone}?&body=${body}` : "#";
            smsLink.setAttribute("aria-disabled", phone ? "false" : "true");
          }
          if (mailLink) {
            const mailSubject = encodeURIComponent(subject);
            const mailBody = encodeURIComponent(message);
            mailLink.href = email ? `mailto:${email}?subject=${mailSubject}&body=${mailBody}` : "#";
            mailLink.setAttribute("aria-disabled", email ? "false" : "true");
          }
        }

        function setup() {
          const btn = document.getElementById("quick-comm-btn");
          const panel = document.getElementById("quick-comm-panel");
          if (btn && panel) {
            btn.addEventListener("click", () => panel.classList.toggle("open"));
          }
          document.getElementById("qc-contact")?.addEventListener("change", updateLinks);
          ["qc-phone", "qc-email", "qc-message", "qc-subject", "qc-preset"].forEach((id) => {
            document.getElementById(id)?.addEventListener("input", updateLinks);
          });
          loadContacts();
          renderSelect();
        }

        function getPresetText(key, contact) {
          const rdv = findLatestRdv(contact?.id);
          const rdvText = rdv ? formatRdv(rdv) : "";
          const name = contact?.name || "";
          const templates = {
            callback: `Bonjour ${name}, je vous rappelle d√®s que possible.`,
            first: `Bonjour ${name}, suite √† votre demande, je reviens vers vous pour √©changer.`,
            quote: `Bonjour ${name}, avez-vous eu le temps de consulter le devis ? Je reste disponible.`,
            thankyou: `Bonjour ${name}, merci pour votre confiance. N'h√©sitez pas si besoin.`,
            "rdv-confirm": rdvText
              ? `Bonjour ${name}, je confirme notre rendez-vous ${rdvText}.`
              : `Bonjour ${name}, je confirme notre rendez-vous.`,
            "rdv-reminder": rdvText
              ? `Bonjour ${name}, petit rappel de notre rendez-vous ${rdvText}.`
              : `Bonjour ${name}, je vous rappelle notre rendez-vous.`,
          };
          return templates[key] || "";
        }

        function findLatestRdv(contactId) {
          if (!contactId) return null;
          const sources = [];
          try {
            const calRaw = localStorage.getItem("comptaCalendar");
            const cal = calRaw ? JSON.parse(calRaw) : [];
            cal.filter((c) => c.clientId === contactId).forEach((c) => sources.push(c));
          } catch (e) {}
          try {
            const ficheRaw = localStorage.getItem("comptaFiches");
            const fiches = ficheRaw ? JSON.parse(ficheRaw) : [];
            fiches
              .filter((f) => f.clientId === contactId)
              .forEach((f) => sources.push({ date: f.date, start: f.time, title: f.title }));
          } catch (e) {}
          const dated = sources.filter((s) => s.date);
          if (!dated.length) return null;
          dated.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
          return dated[dated.length - 1];
        }

        function formatRdv(ev) {
          const d = new Date(ev.date);
          const day = d.toLocaleDateString("fr-FR");
          const time = ev.start ? ` √† ${ev.start}` : "";
          return `pr√©vu le ${day}${time}`;
        }

        document.addEventListener("DOMContentLoaded", setup);
      })();
    </script>

    <footer class="site-footer">
      <div class="footer-content">
        <div class="footer-brand">
          <img id="footer-logo" src="logoOfficielRMS.svg" alt="Logo RMS" />
          <div class="footer-texts">
            <span id="footer-text">RMS Micro-entreprise ‚Äî Compta locale</span>
            <span id="footer-copy">¬© <script>document.write(new Date().getFullYear());</script> RMS Suite</span>
          </div>
        </div>
        <div class="footer-legal">
          <span>RMS Micro-entreprise, SIRET : 93338523900019, Art sur Meurthe 54510 | H√©bergement : Kinsta s√©curis√© | Site statique, z√©ro collecte de donn√©es | HTTPS | Consulting √† 20 ‚Ç¨/h, web sur devis</span>
          <a href="mentions-legales.html">Mentions l√©gales</a>
        </div>
      </div>
    </footer>
  </body>
</html>
